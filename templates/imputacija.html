{% extends "base.html" %}

{% block title %}Imputacija - Trūkstamų reikšmių užpildymas{% endblock %}

{% block nav_imputacija %}active{% endblock %}

{% block extra_css %}
.upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            background-color: #f8f9fa;
        }
        .upload-area.dragover {
            border-color: #28a745;
            background-color: #d4edda;
        }

        /* Dark mode support for upload area */
        [data-theme="dark"] .upload-area {
            border-color: #0d6efd;
            background-color: var(--bg-secondary);
        }

        [data-theme="dark"] .upload-area:hover {
            background-color: #3d3d3d;
        }

        [data-theme="dark"] .upload-area.dragover {
            border-color: #28a745;
            background-color: #1e4d2b;
        }

        /* Dark mode support for tables in analysis results */
        [data-theme="dark"] .table-responsive table {
            color: var(--text-primary);
        }

        [data-theme="dark"] .table-responsive .table th {
            background-color: #1a202c !important;
            color: #e9ecef !important;
            border-color: #495057 !important;
        }

        [data-theme="dark"] .table-responsive .table thead.table-primary th {
            background-color: #2d3748 !important;
            color: #e9ecef !important;
        }

        [data-theme="dark"] .table-responsive .table td {
            color: #e9ecef;
            border-color: #495057;
        }

        [data-theme="dark"] .table-responsive .table-striped tbody tr:nth-of-type(odd) {
            background-color: #2d2d2d;
        }

        [data-theme="dark"] .table-responsive .table-hover tbody tr:hover {
            background-color: #3d3d3d;
        }

        /* Dark mode support for modal */
        [data-theme="dark"] .modal-content {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .modal-header {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-bottom-color: var(--border-color);
        }

        [data-theme="dark"] .modal-body {
            background-color: var(--card-bg);
            color: var(--text-primary);
        }

        [data-theme="dark"] .modal-footer {
            background-color: var(--bg-secondary);
            border-top-color: var(--border-color);
        }

        [data-theme="dark"] .modal-body .form-label {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .modal-body .card.bg-light {
            background-color: var(--bg-secondary) !important;
            color: var(--text-primary);
        }

        [data-theme="dark"] .btn-close {
            filter: invert(1);
        }

        [data-theme="dark"] .list-group-item {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .plot-container {
            margin: 20px 0;
            text-align: center;
        }
        .plot-container img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .stats-card {
            margin: 10px 0;
        }
        .loading {
            display: none;
        }
        .progress-section {
            margin: 20px 0;
        }
        .feature-list {
            max-height: 300px;
            overflow-y: auto;
        }
        #missingOverTimePlot {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #ffffff;
            padding: 10px;
        }
        [data-theme="dark"] #missingOverTimePlot {
            border-color: #495057;
            background: #2d3748;
        }
        #missingOverTimeSection h6 {
            color: #2c3e50;
            font-weight: 600;
        }
        [data-theme="dark"] #missingOverTimeSection h6 {
            color: #e2e8f0;
        }
        [data-theme="dark"] #missingOverTimeSection .text-muted {
            color: #a0aec0 !important;
        }
{% endblock %}

{% block content %}
<div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    Trūkstamų reikšmių užpildymas
                </h1>
                <p class="text-center text-muted mb-4">
                    Įkelkite CSV duomenis ir atlikite trūkstamų reikšmių užpildymą naudojant Random Forest arba XGBoost algoritmus
                </p>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Duomenų įkėlimas</h5>
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            <h5>Vilkite CSV failą čia arba spustelėkite naršymui</h5>
                            <p class="text-muted">Maksimalus failo dydis: 16MB</p>
                            <input type="file" id="fileInput" accept=".csv" style="display: none;">
                        </div>
                        
                        <div class="loading" id="uploadLoading">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border text-primary me-2" role="status"></div>
                                <span>Įkeliamas ir analizuojamas failas...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Overview Section -->
        <div class="row" id="dataOverview" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Duomenų apžvalga</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="statsCards"></div>
                        <div class="row mt-3">
                            <div class="col-12" id="actionButtonsContainer">
                                <button class="btn btn-info me-2" id="analyzeButton" onclick="analyzeData()">
                                    Detali analizė
                                </button>
                                <button class="btn btn-success" id="imputeButton" onclick="showImputeModal()">
                                    Užpildyti trūkstamas reikšmes
                                </button>
                            </div>
                        </div>
                        <!-- Analysis Loading Indicator -->
                        <div class="row mt-3" id="analysisLoading" style="display: none;">
                            <div class="col-12">
                                <div class="d-flex align-items-center justify-content-center p-3">
                                    <div class="spinner-border text-info me-2" role="status"></div>
                                    <span>Atliekama detali duomenų analizė...</span>
                                </div>
                            </div>
                        </div>
                        <!-- No missing data alert -->
                        <div class="row mt-3" id="noMissingAlert" style="display: none;">
                            <div class="col-12">
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Puiku!</strong> Šiame duomenų rinkinyje nėra trūkstamų reikšmių. Visi duomenys pilni ir paruošti analizei.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Imputation Progress Section -->
        <div class="row" id="imputationProgress" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cog fa-spin"></i> Užpildymo procesas</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6 id="progressTitle">Inicijuojamas užpildymo procesas...</h6>
                            <div class="progress mb-3" style="height: 30px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                     role="progressbar"
                                     id="progressBar"
                                     style="width: 0%">
                                    <span id="progressText">0%</span>
                                </div>
                            </div>
                        </div>
                        <div id="progressDetails">
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> Pradėta: <span id="startTime">-</span>
                                    </small>
                                </div>
                                <div class="col-md-6 text-end">
                                    <small class="text-muted">
                                        <i class="fas fa-hourglass-half"></i> Numatomas laikas: <span id="estimatedTime">Skaičiuojama...</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div id="currentStep" class="mt-3">
                            <small class="text-info">
                                <i class="fas fa-info-circle"></i> <span id="stepDescription">Ruošiami duomenys...</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Results Section -->
        <div class="row" id="analysisResults" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Duomenų analizės rezultatai</h5>
                    </div>
                    <div class="card-body">
                        <div id="analysisPlots"></div>

                        <!-- Missing Over Time Section -->
                        <div id="missingOverTimeSection" style="display: none;">
                            <hr class="my-4">
                            <h6>
                                Trūkstamų reikšmių pasiskirstymas pagal metus ir rodiklius
                            </h6>
                            <p class="text-muted small mb-3">
                                Interaktyvi diagrama rodo, kaip trūkstamos reikšmės pasiskirsto skirtingais metais ir skirtingiems rodikliams
                            </p>

                            <!-- Toggle between views -->
                            <div class="btn-group mb-3" role="group">
                                <button type="button" class="btn btn-outline-primary active" id="heatmapViewBtn" onclick="switchTimeView('heatmap')">
                                    Šilumos žemėlapis
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="barViewBtn" onclick="switchTimeView('bar')">
                                    Stulpelinė diagrama
                                </button>
                            </div>

                            <div id="missingOverTimePlot" style="width: 100%; height: 600px; margin-bottom: 40px;"></div>
                        </div>

                        <div id="missingByColumnTable"></div>
                        <div id="summaryStats"></div>

                        <!-- NUTS-2 Map Section -->
                        <div id="nuts2MapSection" style="display: none;">
                            <hr class="my-4">
                            <h6>NUTS-2 regionų žemėlapis</h6>

                            <!-- Map Controls -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="indicatorSelect" class="form-label">
                                        Ekonominis rodiklis:
                                    </label>
                                    <select id="indicatorSelect" class="form-select">
                                        <option value="">-- Pasirinkite rodiklį --</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="yearSelect" class="form-label">
                                        Metai:
                                    </label>
                                    <select id="yearSelect" class="form-select">
                                        <option value="">-- Pasirinkite metus --</option>
                                    </select>
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Naudojimas:</strong>
                                <ul class="mb-0 mt-1">
                                    <li>Užveskite pelės žymeklį ant regiono, kad matytumėte detales ir trūkstamų reikšmių procentą</li>
                                    <li>Naudokite pelės ratą arba dviejų pirštų gestus, kad priartintumėte/atitrauktumėte</li>
                                    <li>Tempkite žemėlapį, kad perkeltumėte vaizdą</li>
                                    <li><span style="background: #ffcccc; padding: 2px 6px; border-radius: 3px;">Šviesiai raudonas</span> - regionas be pasirinkto rodiklio reikšmės</li>
                                </ul>
                            </div>

                            <!-- Map Container -->
                            <div id="imputationMapContainer" style="width: 100%; min-height: 600px; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa; display: flex; justify-content: center; align-items: center;">
                                <div class="text-center">
                                    <i class="fas fa-map-marked-alt fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Pasirinkite rodiklį ir metus, kad matytumėte žemėlapį</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Imputation Results Section -->
        <div class="row" id="imputationResults" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-check-circle"></i> Užpildymo rezultatai</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success" role="alert">
                            <h6><i class="fas fa-check-circle"></i> Užpildymas sėkmingai baigtas!</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <small><strong>Modelis:</strong> <span id="finalModelType">-</span></small>
                                </div>
                                <div class="col-md-3">
                                    <small><strong>Pradėta:</strong> <span id="finalStartTime">-</span></small>
                                </div>
                                <div class="col-md-3">
                                    <small><strong>Baigta:</strong> <span id="finalEndTime">-</span></small>
                                </div>
                                <div class="col-md-3">
                                    <small><strong>Trukmė:</strong> <span id="totalDuration">-</span></small>
                                </div>
                            </div>
                        </div>
                        <div id="imputationPlots"></div>
                        <div id="modelPerformance" style="display: none;"></div>
                        <div id="featureImportance" style="display: none;"></div>
                        <div class="mt-3">
                            <button class="btn btn-primary" id="downloadBtn" style="display: none;">
                                <i class="fas fa-download"></i> Atsisiųsti apdorotus duomenis
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Imputation Settings Modal -->
    <div class="modal fade" id="imputeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Užpildymo nustatymai
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    Modelis
                                </label>
                                <select class="form-select" id="modelType">
                                    <option value="random_forest" selected>
                                        <i class="fas fa-tree"></i> Random Forest
                                    </option>
                                    <option value="xgboost">
                                        <i class="fas fa-bolt"></i> XGBoost
                                    </option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    Medžių skaičius (n_estimators)
                                </label>
                                <input type="number" class="form-control" id="nEstimators" value="100" min="10" max="1000">
                                <div class="form-text">
                                    Daugiau medžių = geresnis tikslumas, bet ilgesnė trukmė
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    Atsitiktinumo būsena
                                </label>
                                <input type="number" class="form-control" id="randomState" value="42">
                                <div class="form-text">
                                    Kartojamų rezultatų užtikrinimui (palikite 42)
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    Maksimalus gylis
                                </label>
                                <select class="form-select" id="maxDepth">
                                    <option value="">Automatinis</option>
                                    <option value="3">3</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                </select>
                                <div class="form-text">
                                    Modelio sudėtingumas. Automatinis - optimaliausias
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    Kryžminė validacija (CV Folds)
                                </label>
                                <select class="form-select" id="cvFolds">
                                    <option value="2" selected>2 (greičiausias)</option>
                                    <option value="3">3</option>
                                    <option value="5">5 (rekomenduojamas)</option>
                                    <option value="10">10 (tiksliausias)</option>
                                </select>
                                <div class="form-text">
                                    Didesnis = tikslesnė metrikų įvertinimas, bet ilgiau užtrunka
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    Post-processing (Empirical Bayes Shrinkage)
                                </label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="usePostProcessing" checked>
                                    <label class="form-check-label" for="usePostProcessing">
                                        Įjungtas
                                    </label>
                                </div>
                                <div class="form-text">
                                    Koreguoja ekstremalias prognozes link regiono vidurkio
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row" id="learningRateRow" style="display: none;">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    Mokymosi greitis (learning_rate)
                                </label>
                                <input type="number" class="form-control" id="learningRate" value="0.1" min="0.001" max="1.0" step="0.01">
                                <div class="form-text">
                                    Mažesnis = lėtesnis, bet tikslesnis mokymas
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">
                                    Išmesti stulpelius iš imputacijos
                                </label>
                                <textarea class="form-control" id="excludeColumns" rows="3" placeholder="Pvz.: geo, year, id_column"></textarea>
                                <div class="form-text">
                                    Įveskite stulpelių pavadinius, kurie neturėtų būti imputuojami, atskirtus kableliais arba tarpais (pvz.: geo, year arba geo year id_column).
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6>Numatoma trukmė:</h6>
                                    <p class="mb-0" id="estimatedDuration">
                                        Priklausomai nuo duomenų dydžio: 30s - 5min
                                        <span id="renderWarning" style="display: none;">
                                            <br><br>
                                            <strong>Pastaba:</strong> Dėl render.com nepakankamų serverio išteklių, modelių apmokymas ir didelių duomenų rinkinių užpildymas gali užtrukti ilgiau arba sugeneruoti klaidą.
                                            Tokiu atveju, rekomenduojama naudoti mažesnius duomenų rinkinius arba paleisti aplikaciją lokaliai.
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Atšaukti
                    </button>
                    <button type="button" class="btn btn-success" onclick="performImputation()">
                        Pradėti užpildymą
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script>
let currentFilename = null;
let currentStats = null;  // Store current file stats for modal

// Rodyti render.com įspėjimą tik ant reapi.lt domeno
if (window.location.hostname.includes('reapi.lt')) {
    document.getElementById('renderWarning').style.display = 'inline';
}

// File upload handling
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const uploadLoading = document.getElementById('uploadLoading');
const dataOverview = document.getElementById('dataOverview');

// Check if file parameter is in URL
const urlParams = new URLSearchParams(window.location.search);
const fileFromUrl = urlParams.get('file');

if (fileFromUrl) {
    // Auto-load file from URL parameter
    loadFileByName(fileFromUrl);
}

// Click to upload
uploadArea.addEventListener('click', () => {
    fileInput.click();
});

// Drag and drop
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');

    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileUpload(files[0]);
    }
});

// File input change
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileUpload(e.target.files[0]);
    }
});

function handleFileUpload(file) {
    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Prašome įkelti CSV failą');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);

    uploadLoading.style.display = 'block';

    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Klaida: ' + data.error);
            uploadLoading.style.display = 'none';
        } else {
            currentFilename = data.filename;
            displayDataOverview(data.stats);
            uploadLoading.style.display = 'none';
            dataOverview.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Įvyko klaida įkeliant failą');
        uploadLoading.style.display = 'none';
    });
}

function loadFileByName(filename) {
    // Show loading state
    uploadLoading.style.display = 'block';
    dataOverview.style.display = 'none';

    // Fetch file statistics
    fetch(`/api/file-stats/${filename}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Klaida: ' + data.error);
                uploadLoading.style.display = 'none';
            } else {
                currentFilename = filename;
                displayDataOverview(data.stats);
                uploadLoading.style.display = 'none';
                dataOverview.style.display = 'block';

                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'alert alert-success alert-dismissible fade show';
                successMsg.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    Failas <strong>${filename}</strong> sėkmingai įkeltas!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container').insertBefore(successMsg, document.querySelector('.container').firstChild);

                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    successMsg.remove();
                }, 5000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Įvyko klaida įkeliant failą: ' + error.message);
            uploadLoading.style.display = 'none';
        });
}

function displayDataOverview(stats) {
    // Store stats globally for use in modal
    currentStats = stats;

    const statsCards = document.getElementById('statsCards');

    const missingCount = Object.values(stats.missing_values).reduce((a, b) => a + b, 0);
    const totalCells = stats.rows * stats.columns;
    const missingPercentage = ((missingCount / totalCells) * 100).toFixed(2);

    // Check if there are any missing values
    const hasMissingData = missingCount > 0;

    // Show/hide impute button based on missing data
    const imputeButton = document.getElementById('imputeButton');
    const noMissingAlert = document.getElementById('noMissingAlert');

    if (hasMissingData) {
        imputeButton.style.display = 'inline-block';
        noMissingAlert.style.display = 'none';
    } else {
        imputeButton.style.display = 'none';
        noMissingAlert.style.display = 'block';
    }

    // Change color based on missing data status
    const missingCountColor = missingCount === 0 ? 'text-success' : 'text-warning';
    const missingPercentageColor = missingPercentage == 0 ? 'text-success' : 'text-danger';

    statsCards.innerHTML = `
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <h3 class="text-primary">${stats.rows.toLocaleString()}</h3>
                    <p class="mb-0">Eilutės</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <h3 class="text-info">${stats.columns}</h3>
                    <p class="mb-0">Stulpeliai</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <h3 class="${missingCountColor}">${missingCount.toLocaleString()}</h3>
                    <p class="mb-0">Trūkstamos reikšmės</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <h3 class="${missingPercentageColor}">${missingPercentage}%</h3>
                    <p class="mb-0">Trūkstamų reikšmių procentas</p>
                </div>
            </div>
        </div>
    `;
}

function analyzeData() {
    if (!currentFilename) return;

    // Show loading indicator
    const analysisLoading = document.getElementById('analysisLoading');
    const analyzeButton = document.getElementById('analyzeButton');
    const analysisResults = document.getElementById('analysisResults');

    analysisLoading.style.display = 'block';
    analyzeButton.disabled = true;
    analyzeButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Analizuojama...';
    analysisResults.style.display = 'none';

    fetch(`/analyze/${currentFilename}`)
    .then(response => response.json())
    .then(data => {
        // Hide loading indicator
        analysisLoading.style.display = 'none';
        analyzeButton.disabled = false;
        analyzeButton.innerHTML = 'Detali analizė';

        if (data.error) {
            alert('Klaida: ' + data.error);
        } else {
            displayAnalysisResults(data);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Hide loading indicator on error
        analysisLoading.style.display = 'none';
        analyzeButton.disabled = false;
        analyzeButton.innerHTML = 'Detali analizė';
        alert('Įvyko klaida analizuojant duomenis');
    });
}

function displayAnalysisResults(result) {
    const plotsDiv = document.getElementById('analysisPlots');
    let plotsHtml = '';

    Object.entries(result.plots).forEach(([plotName, plotData]) => {
        plotsHtml += `
            <div class="plot-container">
                <h6>${plotName.replace('_', ' ').toUpperCase()}</h6>
                <img src="data:image/png;base64,${plotData}" alt="${plotName}">
            </div>
        `;
    });

    plotsDiv.innerHTML = plotsHtml;

    // Display missing values by column table
    if (result.missing_by_column && result.missing_by_column.length > 0) {
        const tableDiv = document.getElementById('missingByColumnTable');
        let tableHtml = `
            <div class="row mt-4">
                <div class="col-12">
                    <h6>Trūkstamų reikšmių procentas pagal stulpelį</h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-primary">
                                <tr>
                                    <th>Stulpelis</th>
                                    <th>Duomenų tipas</th>
                                    <th>Užpildytų kiekis</th>
                                    <th>Trūkstamų kiekis</th>
                                    <th>Trūkstamų (%)</th>
                                </tr>
                            </thead>
                            <tbody>
        `;

        result.missing_by_column.forEach(item => {
            const progressWidth = Math.min(item.missing_percentage, 100);
            const badgeClass = item.missing_percentage >= 50 ? 'bg-danger' :
                             item.missing_percentage >= 25 ? 'bg-warning' : 'bg-info';

            tableHtml += `
                <tr>
                    <td><strong>${item.column}</strong></td>
                    <td><span class="badge bg-secondary">${item.data_type}</span></td>
                    <td><span class="badge bg-success">${item.filled_count.toLocaleString()}</span></td>
                    <td>${item.missing_count.toLocaleString()}</td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar ${badgeClass.replace('bg-', 'bg-')}"
                                 role="progressbar"
                                 style="width: ${progressWidth}%"
                                 aria-valuenow="${item.missing_percentage}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                ${item.missing_percentage}%
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        });

        tableHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;

        tableDiv.innerHTML = tableHtml;
    }

    const statsDiv = document.getElementById('summaryStats');
    const missing = result.missing_summary;
    statsDiv.innerHTML = `
        <div class="row">
            <div class="col-12">
                <h6>Trūkstamų reikšmių santrauka</h6>
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Iš viso trūkstamų reikšmių:</span>
                        <span class="badge bg-warning">${missing.total_missing.toLocaleString()}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Stulpelių su trūkstamomis reikšmėmis:</span>
                        <span class="badge bg-info">${missing.columns_with_missing}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Pilnos eilutės:</span>
                        <span class="badge bg-success">${missing.complete_rows.toLocaleString()}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Bendras trūkstamų reikšmių procentas:</span>
                        <span class="badge bg-danger">${missing.missing_percentage}%</span>
                    </li>
                </ul>
            </div>
        </div>
    `;

    // Check if data has geo column (NUTS-2 codes) - show map section
    if (result.columns && result.columns.includes('geo')) {
        document.getElementById('nuts2MapSection').style.display = 'block';
        initializeNUTS2Map();
    }

    // Check if missing_over_time data exists - show time-based visualization
    if (result.missing_over_time && result.missing_over_time.years.length > 0) {
        document.getElementById('missingOverTimeSection').style.display = 'block';
        renderMissingOverTime(result.missing_over_time);
    }

    document.getElementById('analysisResults').style.display = 'block';
}

function renderMissingOverTime(data) {
    // Store data for view switching
    currentTimeViewData = data;

    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';

    // Prepare data for heatmap
    const indicators = Object.keys(data.indicators);
    const years = data.years;

    // Create matrix of missing percentages
    const zValues = indicators.map(indicator => {
        return data.indicators[indicator].map(yearData => yearData.missing_percentage);
    });

    // Create hover text with detailed information
    const hoverText = indicators.map(indicator => {
        return data.indicators[indicator].map(yearData =>
            `Rodiklis: ${indicator}<br>` +
            `Metai: ${yearData.year}<br>` +
            `Trūkstamos: ${yearData.missing_count} iš ${yearData.total_count}<br>` +
            `Procentas: ${yearData.missing_percentage}%`
        );
    });

    const trace = {
        z: zValues,
        x: years,
        y: indicators,
        type: 'heatmap',
        colorscale: [
            [0, '#d4edda'],      // Light green for 0% missing
            [0.1, '#fff3cd'],    // Light yellow for 10%
            [0.25, '#ffeaa7'],   // Yellow for 25%
            [0.5, '#fdcb6e'],    // Orange for 50%
            [0.75, '#e17055'],   // Dark orange for 75%
            [1, '#d63031']       // Red for 100%
        ],
        hovertext: hoverText,
        hoverinfo: 'text',
        colorbar: {
            title: {
                text: 'Trūkstamų<br>reikšmių %',
                side: 'right'
            },
            ticksuffix: '%',
            thickness: 20,
            len: 0.7,
            tickfont: {
                color: isDarkMode ? '#e9ecef' : '#495057'
            },
            titlefont: {
                color: isDarkMode ? '#e9ecef' : '#495057'
            }
        },
        xgap: 2,
        ygap: 2
    };

    const layout = {
        title: {
            text: 'Trūkstamų reikšmių pasiskirstymas pagal metus ir rodiklius',
            font: {
                size: 16,
                color: isDarkMode ? '#e9ecef' : '#2c3e50',
                weight: 600
            }
        },
        xaxis: {
            title: {
                text: 'Metai',
                font: {
                    color: isDarkMode ? '#e9ecef' : '#495057'
                }
            },
            tickfont: {
                color: isDarkMode ? '#a0aec0' : '#6c757d'
            },
            gridcolor: isDarkMode ? '#495057' : '#e9ecef',
            showgrid: true
        },
        yaxis: {
            title: {
                text: 'Ekonominiai rodikliai',
                font: {
                    color: isDarkMode ? '#e9ecef' : '#495057'
                }
            },
            tickfont: {
                color: isDarkMode ? '#a0aec0' : '#6c757d',
                size: 10
            },
            gridcolor: isDarkMode ? '#495057' : '#e9ecef',
            showgrid: true,
            automargin: true
        },
        plot_bgcolor: isDarkMode ? '#1a202c' : '#ffffff',
        paper_bgcolor: isDarkMode ? '#2d3748' : '#f8f9fa',
        font: {
            family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
            color: isDarkMode ? '#e9ecef' : '#495057'
        },
        autosize: true,
        margin: {
            l: 200,
            r: 80,
            t: 80,
            b: 80
        },
        hoverlabel: {
            bgcolor: isDarkMode ? '#4a5568' : '#ffffff',
            bordercolor: isDarkMode ? '#718096' : '#dee2e6',
            font: {
                color: isDarkMode ? '#e9ecef' : '#212529',
                size: 12
            }
        }
    };

    const config = {
        responsive: true,
        displayModeBar: true,
        displaylogo: false,
        modeBarButtonsToRemove: ['lasso2d', 'select2d'],
        toImageButtonOptions: {
            format: 'png',
            filename: 'trukstamu_reiksmiu_pasiskirstymas',
            height: 800,
            width: 1200,
            scale: 2
        }
    };

    Plotly.newPlot('missingOverTimePlot', [trace], layout, config).then(() => {
        // Force resize after plot is created to ensure proper dimensions
        setTimeout(() => {
            Plotly.Plots.resize('missingOverTimePlot');
        }, 100);
    });

    // Update plot on theme change
    const observer = new MutationObserver(() => {
        const newIsDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
        if (newIsDarkMode !== isDarkMode) {
            renderMissingOverTime(data);
        }
    });

    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-theme']
    });
}

let currentTimeViewData = null;
let currentTimeView = 'heatmap';

function switchTimeView(view) {
    if (!currentTimeViewData) return;

    currentTimeView = view;

    // Update button states
    document.getElementById('heatmapViewBtn').classList.remove('active');
    document.getElementById('barViewBtn').classList.remove('active');

    if (view === 'heatmap') {
        document.getElementById('heatmapViewBtn').classList.add('active');
        renderMissingOverTime(currentTimeViewData);
    } else {
        document.getElementById('barViewBtn').classList.add('active');
        renderMissingOverTimeBar(currentTimeViewData);
    }
}

function renderMissingOverTimeBar(data) {
    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';

    // Prepare data for stacked bar chart
    const years = data.years;
    const indicators = Object.keys(data.indicators);

    // Create traces for each indicator
    const traces = indicators.map(indicator => {
        const missingCounts = data.indicators[indicator].map(yearData => yearData.missing_count);

        return {
            name: indicator,
            x: years,
            y: missingCounts,
            type: 'bar',
            hovertemplate: `<b>${indicator}</b><br>` +
                          'Metai: %{x}<br>' +
                          'Trūkstamos: %{y}<br>' +
                          '<extra></extra>'
        };
    });

    const layout = {
        title: {
            text: 'Trūkstamų reikšmių kiekis pagal metus (stacked)',
            font: {
                size: 16,
                color: isDarkMode ? '#e9ecef' : '#2c3e50',
                weight: 600
            }
        },
        barmode: 'stack',
        xaxis: {
            title: {
                text: 'Metai',
                font: {
                    color: isDarkMode ? '#e9ecef' : '#495057'
                }
            },
            tickfont: {
                color: isDarkMode ? '#a0aec0' : '#6c757d'
            },
            gridcolor: isDarkMode ? '#495057' : '#e9ecef'
        },
        yaxis: {
            title: {
                text: 'Trūkstamų reikšmių skaičius',
                font: {
                    color: isDarkMode ? '#e9ecef' : '#495057'
                }
            },
            tickfont: {
                color: isDarkMode ? '#a0aec0' : '#6c757d'
            },
            gridcolor: isDarkMode ? '#495057' : '#e9ecef'
        },
        plot_bgcolor: isDarkMode ? '#1a202c' : '#ffffff',
        paper_bgcolor: isDarkMode ? '#2d3748' : '#f8f9fa',
        font: {
            family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
            color: isDarkMode ? '#e9ecef' : '#495057'
        },
        autosize: true,
        showlegend: true,
        legend: {
            orientation: 'v',
            x: 1.02,
            y: 1,
            font: {
                color: isDarkMode ? '#e9ecef' : '#495057',
                size: 10
            },
            bgcolor: isDarkMode ? '#2d3748' : '#ffffff',
            bordercolor: isDarkMode ? '#4a5568' : '#dee2e6',
            borderwidth: 1
        },
        margin: {
            l: 80,
            r: 200,
            t: 80,
            b: 80
        },
        hoverlabel: {
            bgcolor: isDarkMode ? '#4a5568' : '#ffffff',
            bordercolor: isDarkMode ? '#718096' : '#dee2e6',
            font: {
                color: isDarkMode ? '#e9ecef' : '#212529',
                size: 12
            }
        }
    };

    const config = {
        responsive: true,
        displayModeBar: true,
        displaylogo: false,
        modeBarButtonsToRemove: ['lasso2d', 'select2d'],
        toImageButtonOptions: {
            format: 'png',
            filename: 'trukstamu_reiksmiu_stacked_bar',
            height: 800,
            width: 1200,
            scale: 2
        }
    };

    Plotly.newPlot('missingOverTimePlot', traces, layout, config).then(() => {
        // Force resize after plot is created to ensure proper dimensions
        setTimeout(() => {
            Plotly.Plots.resize('missingOverTimePlot');
        }, 100);
    });
}

// NUTS-2 Map functionality
let mapData = null;
let currentMapVisualization = null;
let availableIndicators = [];
let availableYears = [];

function initializeNUTS2Map() {
    console.log('Inicializuojamas NUTS-2 žemėlapis');
    loadMapData();
}

async function loadMapData() {
    if (!currentFilename) {
        console.error('Nėra įkelto failo');
        return;
    }

    try {
        const response = await fetch(`/get_csv_data/${currentFilename}`);
        if (response.ok) {
            const data = await response.json();
            mapData = data;
            console.log('Žemėlapio duomenys įkelti:', mapData.length, 'įrašų');

            if (mapData.length > 0) {
                availableYears = [...new Set(mapData.map(row => row.time_period).filter(y => y))].sort();

                const firstRow = mapData[0];
                const allColumns = Object.keys(firstRow).filter(key =>
                    key !== 'geo' && key !== 'year'
                );

                availableIndicators = allColumns.filter(col => {
                    return mapData.some(row => {
                        const val = row[col];
                        return val !== null && val !== '' && val !== undefined && !isNaN(parseFloat(val));
                    });
                });

                console.log('Visi stulpeliai:', allColumns);
                console.log('Galimi metai:', availableYears);
                console.log('Galimi rodikliai (su duomenimis):', availableIndicators);

                populateIndicatorSelect();
                populateYearSelect();

                document.getElementById('indicatorSelect').addEventListener('change', updateNUTS2Map);
                document.getElementById('yearSelect').addEventListener('change', updateNUTS2Map);
            }
        } else {
            console.error('Nepavyko įkelti duomenų žemėlapiui');
        }
    } catch (error) {
        console.error('Klaida kraunant duomenis:', error);
    }
}

function populateIndicatorSelect() {
    const select = document.getElementById('indicatorSelect');
    select.innerHTML = '<option value="">-- Pasirinkite rodiklį --</option>';

    availableIndicators.forEach(indicator => {
        const option = document.createElement('option');
        option.value = indicator;
        option.textContent = indicator;
        select.appendChild(option);
    });

    console.log('Įkelti rodikliai:', availableIndicators);
}

function populateYearSelect() {
    const select = document.getElementById('yearSelect');
    select.innerHTML = '<option value="">-- Pasirinkite metus --</option>';

    availableYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        select.appendChild(option);
    });
}

async function updateNUTS2Map() {
    const indicator = document.getElementById('indicatorSelect').value;
    const year = document.getElementById('yearSelect').value;

    console.log('Atnaujinamas žemėlapis:', { indicator, year });

    if (!indicator || !year || !mapData) {
        console.log('Trūksta parametrų');
        return;
    }

    try {
        const container = document.getElementById('imputationMapContainer');
        container.innerHTML = `
            <div class="text-center">
                <i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i>
                <p>Kraunamas žemėlapis...</p>
            </div>
        `;

        const allRegionsForYear = mapData.filter(row => {
            return row.time_period == year && row.geo && row.geo.length >= 2;
        });

        console.log('Visi regionai pasirinktais metais:', allRegionsForYear.length, 'įrašų');

        if (allRegionsForYear.length === 0) {
            container.innerHTML = `
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <p>Nėra duomenų pasirinktam rodikliui ir metams</p>
                </div>
            `;
            return;
        }

        const mapDataForViz = allRegionsForYear.map(row => {
            const totalIndicators = availableIndicators.length;
            const missingCount = availableIndicators.filter(ind => {
                const val = row[ind];
                return val === null || val === '' || val === undefined;
            }).length;

            const missingPercentage = (missingCount / totalIndicators * 100).toFixed(1);

            return {
                region: row.geo,
                value: parseFloat(row[indicator]),
                label: indicator,
                missingPercentage: parseFloat(missingPercentage),
                missingCount: missingCount,
                totalIndicators: totalIndicators,
                hasValue: row[indicator] !== null && row[indicator] !== '' && row[indicator] !== undefined
            };
        });

        console.log('Paruošti duomenys žemėlapiui:', mapDataForViz.length, 'regionų');
        console.log('Duomenų pavyzdys:', mapDataForViz.slice(0, 3));

        const totalRegions = mapDataForViz.length;
        const regionsWithValue = mapDataForViz.filter(d => d.hasValue).length;
        const regionsWithoutValue = totalRegions - regionsWithValue;
        const avgMissingPercentage = (mapDataForViz.reduce((sum, d) => sum + d.missingPercentage, 0) / totalRegions).toFixed(1);

        const statsHtml = `
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="alert alert-info mb-0">
                        <strong>Viso regionų:</strong> ${totalRegions}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="alert alert-success mb-0">
                        <strong>Su reikšme:</strong> ${regionsWithValue}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="alert alert-warning mb-0">
                        <strong>Be reikšmės:</strong> ${regionsWithoutValue}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="alert alert-secondary mb-0">
                        <strong>Vid. trūkstamų:</strong> ${avgMissingPercentage}%
                    </div>
                </div>
            </div>
        `;

        const mapSection = document.getElementById('imputationMapContainer').parentElement;
        let statsContainer = document.getElementById('mapStatsContainer');
        if (!statsContainer) {
            statsContainer = document.createElement('div');
            statsContainer.id = 'mapStatsContainer';
            mapSection.insertBefore(statsContainer, document.getElementById('imputationMapContainer'));
        }
        statsContainer.innerHTML = statsHtml;

        container.innerHTML = '';
        container.style.display = 'flex';
        container.style.justifyContent = 'center';
        container.style.alignItems = 'center';

        if (currentMapVisualization) {
            currentMapVisualization.destroy();
        }

        currentMapVisualization = new MapVisualization('imputationMapContainer', {
            width: 800,
            height: 600
        });

        const geoJsonUrl = 'https://raw.githubusercontent.com/eurostat/Nuts2json/master/pub/v2/2021/4326/20M/nutsrg_2.json';
        await currentMapVisualization.loadGeoJSON(geoJsonUrl);

        const regionsInData = new Set(mapDataForViz.map(d => d.region));
        console.log('Regionai duomenyse:', [...regionsInData]);

        if (currentMapVisualization.geoData) {
            const originalCount = currentMapVisualization.geoData.features.length;

            currentMapVisualization.geoData.features =
                currentMapVisualization.geoData.features.filter(f => {
                    const nutsId = f.properties.NUTS_ID || f.properties.id;

                    if (nutsId && regionsInData.has(nutsId)) {
                        console.log('Matching region found:', nutsId);
                        return true;
                    }

                    return false;
                });

            console.log(`Filtruoti GeoJSON regionai: ${currentMapVisualization.geoData.features.length} iš ${originalCount}`);
            console.log('Regionai žemėlapyje:', currentMapVisualization.geoData.features.map(f => f.properties.NUTS_ID || f.properties.id));
        }

        currentMapVisualization.setData(mapDataForViz);
        currentMapVisualization.render();
        currentMapVisualization.addLegend({
            width: 250,
            height: 20
        });

        console.log('Žemėlapis sėkmingai sukurtas');

    } catch (error) {
        console.error('Klaida kuriant žemėlapį:', error);
        document.getElementById('imputationMapContainer').innerHTML = `
            <div class="text-center text-danger">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <p>Klaida kuriant žemėlapį: ${error.message}</p>
            </div>
        `;
    }
}

function showImputeModal() {
    const modal = new bootstrap.Modal(document.getElementById('imputeModal'));
    modal.show();

    // Handle model type change to show/hide learning rate and change n_estimators and max_depth
    const modelTypeSelect = document.getElementById('modelType');
    const learningRateRow = document.getElementById('learningRateRow');
    const nEstimatorsInput = document.getElementById('nEstimators');
    const maxDepthSelect = document.getElementById('maxDepth');

    // Function to update model-specific defaults
    function updateModelDefaults(modelType) {
        if (modelType === 'xgboost') {
            learningRateRow.style.display = 'block';
            nEstimatorsInput.value = 200;
            // Set XGBoost default max_depth = 6
            maxDepthSelect.value = '6';
        } else {
            learningRateRow.style.display = 'none';
            nEstimatorsInput.value = 100;
            // Set Random Forest default max_depth = 15
            maxDepthSelect.value = '15';
        }
    }

    // Set initial state based on current selection
    updateModelDefaults(modelTypeSelect.value);

    // Add event listener for model type changes
    modelTypeSelect.addEventListener('change', (e) => {
        updateModelDefaults(e.target.value);
    });
}

let imputationStartTime;

function updateProgress(percentage, step, timeElapsed = null) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const stepDescription = document.getElementById('stepDescription');
    const estimatedTime = document.getElementById('estimatedTime');

    progressBar.style.width = percentage + '%';
    progressText.textContent = Math.round(percentage) + '%';
    stepDescription.textContent = step;

    if (timeElapsed && percentage > 10) {
        const totalEstimated = (timeElapsed / percentage) * 100;
        const remaining = totalEstimated - timeElapsed;
        estimatedTime.textContent = Math.round(remaining / 1000) + 's';
    }
}

function simulateProgress(duration) {
    let progress = 0;
    const currentModelType = document.getElementById('modelType') ?
        document.getElementById('modelType').value : 'random_forest';
    const modelDisplayName = currentModelType === 'xgboost' ? 'XGBoost' : 'Random Forest';

    const steps = [
        { progress: 10, text: "Analizuojami duomenų tipai..." },
        { progress: 25, text: "Koduojami kategoriniai duomenys..." },
        { progress: 40, text: "Ruošiami treniruotės duomenys..." },
        { progress: 60, text: `Mokomi ${modelDisplayName} modeliai...` },
        { progress: 80, text: "Prognozuojamos trūkstamos reikšmės..." },
        { progress: 95, text: "Generuojami grafikai ir ataskaitos..." }
    ];

    let stepIndex = 0;
    const interval = duration / 100;

    const timer = setInterval(() => {
        progress += 1;

        if (stepIndex < steps.length && progress >= steps[stepIndex].progress) {
            const timeElapsed = Date.now() - imputationStartTime;
            updateProgress(progress, steps[stepIndex].text, timeElapsed);
            stepIndex++;
        } else {
            const timeElapsed = Date.now() - imputationStartTime;
            updateProgress(progress, stepIndex > 0 ? steps[stepIndex - 1].text : "Apdorojami duomenys...", timeElapsed);
        }

        if (progress >= 95) {
            clearInterval(timer);
        }
    }, interval);

    return timer;
}

async function performImputation() {
    if (!currentFilename) return;

    const modelType = document.getElementById('modelType').value;
    const nEstimators = document.getElementById('nEstimators').value;
    const randomState = document.getElementById('randomState').value;
    const maxDepthSelect = document.getElementById('maxDepth').value;
    const maxDepth = maxDepthSelect === '' ? null : parseInt(maxDepthSelect);
    const learningRateInput = document.getElementById('learningRate').value;
    const learningRate = modelType === 'xgboost' && learningRateInput ? parseFloat(learningRateInput) : null;
    const cvFolds = parseInt(document.getElementById('cvFolds').value);
    const usePostProcessing = document.getElementById('usePostProcessing').checked;

    // Get excluded columns from text input (comma or space separated)
    const excludeColumnsInput = document.getElementById('excludeColumns');
    const excludeColumnsText = excludeColumnsInput.value.trim();

    // Parse comma or space separated column names
    const excludedColumns = excludeColumnsText
        ? excludeColumnsText.split(/[,\s]+/).filter(col => col.length > 0)
        : [];

    bootstrap.Modal.getInstance(document.getElementById('imputeModal')).hide();

    document.getElementById('imputationProgress').style.display = 'block';
    document.getElementById('imputationResults').style.display = 'none';

    imputationStartTime = Date.now();
    const startTimeStr = new Date(imputationStartTime).toLocaleTimeString('lt-LT');
    document.getElementById('startTime').textContent = startTimeStr;

    const modelName = modelType === 'xgboost' ? 'XGBoost' : 'Random Forest';
    const progressTitleText = excludedColumns.length > 0
        ? `Inicijuojamas ${modelName} užpildymo procesas (${excludedColumns.length} stulpeliai praleisti)...`
        : `Inicijuojamas ${modelName} užpildymo procesas...`;
    document.getElementById('progressTitle').textContent = progressTitleText;

    const estimatedDuration = parseInt(nEstimators) * (modelType === 'xgboost' ? 60 : 50);
    const progressTimer = simulateProgress(estimatedDuration);

    try {
        const response = await fetch(`/impute/${currentFilename}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model_type: modelType,
                n_estimators: parseInt(nEstimators),
                random_state: parseInt(randomState),
                max_depth: maxDepth,
                learning_rate: learningRate,
                cv_folds: cvFolds,
                use_post_processing: usePostProcessing,
                exclude_columns: excludedColumns
            })
        });

        const result = await response.json();

        clearInterval(progressTimer);

        if (response.ok) {
            updateProgress(100, "Užpildymas baigtas!");

            const endTime = Date.now();
            const duration = endTime - imputationStartTime;
            const durationStr = Math.round(duration / 1000) + 's';
            const endTimeStr = new Date(endTime).toLocaleTimeString('lt-LT');

            setTimeout(() => {
                updateProgress(100, "Užpildymas baigtas! Peržiūrėkite rezultatus žemiau.");
                document.getElementById('progressBar').classList.remove('progress-bar-animated');

                const progressCard = document.querySelector('#imputationProgress .card-body');

                const existingBtn = progressCard.querySelector('.view-results-button');
                if (existingBtn) {
                    existingBtn.remove();
                }

                const viewResultsBtn = document.createElement('div');
                viewResultsBtn.className = 'text-center mt-3 view-results-button';

                const usedModelType = result.model_type || 'Random Forest';
                const modelDisplayName = usedModelType === 'xgboost' ? 'XGBoost' : 'Random Forest';

                // If result_id exists, redirect to results page
                if (result.result_id) {
                    viewResultsBtn.innerHTML = `
                        <div class="alert alert-info mb-3">
                            <small><i class="fas fa-info-circle"></i> Naudotas modelis: <strong>${modelDisplayName}</strong></small>
                        </div>
                        <a href="/rezultatai/${result.result_id}" class="btn btn-primary btn-lg">
                            <i class="fas fa-chart-bar"></i> Peržiūrėti ${modelDisplayName} rezultatus
                        </a>
                    `;
                } else {
                    // Fallback to old method if no result_id
                    viewResultsBtn.innerHTML = `
                        <div class="alert alert-info mb-3">
                            <small><i class="fas fa-info-circle"></i> Naudotas modelis: <strong>${modelDisplayName}</strong></small>
                        </div>
                        <button class="btn btn-primary btn-lg" onclick="showResults()">
                            <i class="fas fa-chart-bar"></i> Peržiūrėti ${modelDisplayName} rezultatus
                        </button>
                    `;

                    window.imputationResultData = {
                        result: result,
                        startTime: startTimeStr,
                        endTime: endTimeStr,
                        duration: durationStr,
                        modelType: modelType
                    };
                }

                progressCard.appendChild(viewResultsBtn);
            }, 1000);
        } else {
            document.getElementById('imputationProgress').style.display = 'none';
            alert('Užpildymas nepavyko: ' + result.error);
        }
    } catch (error) {
        clearInterval(progressTimer);
        document.getElementById('imputationProgress').style.display = 'none';
        alert('Užpildymas nepavyko: ' + error.message);
    }
}

function displayImputationResults(result) {
    const plotsDiv = document.getElementById('imputationPlots');
    let plotsHtml = '';

    plotsHtml += `
        <div class="row mb-4">
            <div class="col-12 text-center">
                <button class="btn btn-primary me-2" id="showFeatureImportanceBtn" onclick="showFeatureImportance()">
                    <i class="fas fa-chart-bar"></i> Požymių svarba
                </button>
                <button class="btn btn-outline-primary" id="showAccuracyMetricsBtn" onclick="showAccuracyMetrics()">
                    <i class="fas fa-calculator"></i> Tikslumo metrikos
                </button>
            </div>
        </div>

        <div id="featureImportanceSection" style="display: block;">
        </div>

        <div id="accuracyMetricsSection" style="display: none;">
        </div>
    `;

    plotsDiv.innerHTML = plotsHtml;

    window.currentImputationResult = result;

    showFeatureImportance();

    const downloadBtn = document.getElementById('downloadBtn');
    downloadBtn.style.display = 'block';
    downloadBtn.onclick = () => downloadFile(result.imputed_filename);
}

function showResults() {
    document.getElementById('dataOverview').style.display = 'none';
    document.getElementById('analysisResults').style.display = 'none';
    document.getElementById('imputationProgress').style.display = 'none';

    if (window.imputationResultData) {
        const data = window.imputationResultData;
        const modelDisplayName = data.modelType === 'xgboost' ? 'XGBoost' : 'Random Forest';

        document.getElementById('finalModelType').textContent = modelDisplayName;
        document.getElementById('finalStartTime').textContent = data.startTime;
        document.getElementById('finalEndTime').textContent = data.endTime;
        document.getElementById('totalDuration').textContent = data.duration;
        displayImputationResults(data.result);
        document.getElementById('imputationResults').style.display = 'block';

        window.scrollTo({ top: 0, behavior: 'smooth' });

        addNavigationButtons();
    }
}

function addNavigationButtons() {
    const resultsCard = document.querySelector('#imputationResults .card-body');

    if (document.getElementById('resultNavigation')) {
        return;
    }

    const navigation = document.createElement('div');
    navigation.id = 'resultNavigation';
    navigation.className = 'mb-4 p-3 bg-light rounded';
    navigation.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <button class="btn btn-outline-secondary" onclick="goBackToAnalysis()">
                    <i class="fas fa-arrow-left"></i> Atgal į analizę
                </button>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-outline-primary" onclick="startNewImputation()">
                    <i class="fas fa-redo"></i> Naujas užpildymas
                </button>
            </div>
        </div>
    `;
    resultsCard.insertBefore(navigation, resultsCard.firstChild);
}

function goBackToAnalysis() {
    document.getElementById('imputationResults').style.display = 'none';
    document.getElementById('dataOverview').style.display = 'block';
    document.getElementById('analysisResults').style.display = 'block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function startNewImputation() {
    const progressCard = document.querySelector('#imputationProgress .card-body');
    const viewResultsBtn = progressCard.querySelector('.text-center');
    if (viewResultsBtn) {
        viewResultsBtn.remove();
    }

    document.getElementById('progressBar').classList.add('progress-bar-animated');
    updateProgress(0, "Ruošiami duomenys...");

    document.getElementById('imputationResults').style.display = 'none';
    document.getElementById('dataOverview').style.display = 'block';
    document.getElementById('analysisResults').style.display = 'block';
    window.scrollTo({ top: 0, behavior: 'smooth' });

    setTimeout(() => {
        showImputeModal();
    }, 500);
}

function showFeatureImportance() {
    document.getElementById('showFeatureImportanceBtn').className = 'btn btn-primary me-2';
    document.getElementById('showAccuracyMetricsBtn').className = 'btn btn-outline-primary';

    document.getElementById('featureImportanceSection').style.display = 'block';
    document.getElementById('accuracyMetricsSection').style.display = 'none';

    if (window.currentImputationResult) {
        const result = window.currentImputationResult;
        const featureSection = document.getElementById('featureImportanceSection');
        let featureHtml = '';

        if (result.plots && result.plots['feature_importance']) {
            featureHtml += `
                <div class="plot-container mb-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">Požymių svarba (Feature Importance)</h6>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">Grafikai rodo, kurie duomenų stulpeliai labiausiai prisidėjo prie trūkstamų reikšmių prognozavimo</p>
                            <img src="data:image/png;base64,${result.plots['feature_importance']}" alt="feature_importance" class="img-fluid">
                        </div>
                    </div>
                </div>
            `;
        }

        if (result.feature_importance) {
            featureHtml += '<div class="mt-4"><h6>Požymių svarba pagal užpildytą stulpelį</h6>';

            Object.entries(result.feature_importance).forEach(([column, importance]) => {
                featureHtml += `
                    <div class="mb-3">
                        <h6 class="text-muted">Užpildytas stulpelis: ${column}</h6>
                        <div class="feature-list">
                `;

                const sortedFeatures = Object.entries(importance)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10);

                sortedFeatures.forEach(([feature, score]) => {
                    const percentage = (score * 100).toFixed(2);
                    featureHtml += `
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small">${feature}</span>
                            <span class="badge bg-secondary">${percentage}%</span>
                        </div>
                    `;
                });

                featureHtml += '</div></div>';
            });

            featureHtml += '</div>';
        }

        featureSection.innerHTML = featureHtml;
    }
}

function showAccuracyMetrics() {
    document.getElementById('showFeatureImportanceBtn').className = 'btn btn-outline-primary me-2';
    document.getElementById('showAccuracyMetricsBtn').className = 'btn btn-primary';

    document.getElementById('featureImportanceSection').style.display = 'none';
    document.getElementById('accuracyMetricsSection').style.display = 'block';

    if (window.currentImputationResult) {
        const result = window.currentImputationResult;
        const metricsSection = document.getElementById('accuracyMetricsSection');

        let metricsHtml = '<div class="mt-4"><h5>Modelių efektyvumo vertinimas</h5>';

        if (result.plots && result.plots['performance_table']) {
            metricsHtml += `
                <div class="plot-container mb-4">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Modelių efektyvumo santrauka</h6>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">Išsami lentelė su visomis svarbiomis metrikomis kiekvienam užpildytam stulpeliui</p>
                            <img src="data:image/png;base64,${result.plots['performance_table']}" alt="performance_table" class="img-fluid">
                        </div>
                    </div>
                </div>
            `;
        }

        const metricCharts = ['rmse_comparison', 'r2_comparison', 'mape_comparison', 'radar_comparison'];

        metricCharts.forEach(chartName => {
            if (result.plots && result.plots[chartName]) {
                let title = '';
                let description = '';
                let cardColor = 'bg-info';

                switch(chartName) {
                    case 'rmse_comparison':
                        title = 'RMSE (Root Mean Square Error) palyginimas';
                        description = 'Mažesnė RMSE reikšmė rodo geresnį modelio tikslumą. Matuoja vidutinę kvadratinę paklaidą.';
                        cardColor = 'bg-danger';
                        break;
                    case 'r2_comparison':
                        title = 'R² (Determinacijos koeficientas) palyginimas';
                        description = 'R² rodo, kiek proc. dispersijos paaiškina modelis. Reikšmės artimos 1 rodo gerą modelį.';
                        cardColor = 'bg-success';
                        break;
                    case 'mape_comparison':
                        title = 'MAPE (Mean Absolute Percentage Error) palyginimas';
                        description = 'Procentinė absoliuti paklaida. MAPE < 10% - labai geras, < 20% - geras modelis.';
                        cardColor = 'bg-warning';
                        break;
                    case 'radar_comparison':
                        title = 'Kompleksinis modelių palyginimas';
                        description = 'Daugiamatis modelių efektyvumo palyginimas. Didesnis plotas rodo geresnį modelį.';
                        cardColor = 'bg-secondary';
                        break;
                }

                metricsHtml += `
                    <div class="plot-container mb-4">
                        <div class="card">
                            <div class="card-header ${cardColor} text-white">
                                <h6 class="mb-0">${title}</h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">${description}</p>
                                <img src="data:image/png;base64,${result.plots[chartName]}" alt="${chartName}" class="img-fluid">
                            </div>
                        </div>
                    </div>
                `;
            }
        });

        metricsHtml += '</div>';
        metricsSection.innerHTML = metricsHtml;
    }
}

function downloadFile(filename) {
    window.open(`/download/${filename}`, '_blank');
}
</script>
{% endblock %}