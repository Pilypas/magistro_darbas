{% extends "base.html" %}

{% block title %}Komentarai - Duomenų analizės sistema{% endblock %}

{% block nav_komentarai %}active{% endblock %}

{% block extra_css %}
.comment-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .comment-card:hover {
            transform: translateY(-2px);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .comment-author {
            font-weight: bold;
            color: #495057;
        }

        .comment-date {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .comment-content {
            color: #333;
            line-height: 1.6;
        }

        .form-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .form-title {
            color: #495057;
            margin-bottom: 25px;
        }

        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: white;
            padding: 12px 30px;
            font-weight: 500;
            transition: transform 0.3s ease;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            color: white;
        }

        .loading-spinner {
            display: none;
        }

        .alert {
            border-radius: 10px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
            color: #495057;
        }

        .comment-email {
            color: #6c757d;
            font-size: 0.9rem;
            font-style: italic;
        }

        .no-comments {
            text-align: center;
            padding: 50px 20px;
            background: white;
            border-radius: 15px;
            color: #6c757d;
        }

        .comment-icon {
            color: #667eea;
            margin-right: 10px;
        }

        /* Dark mode support */
        [data-theme="dark"] .comment-card {
            background: var(--card-bg);
            color: var(--text-primary);
        }

        [data-theme="dark"] .comment-header {
            border-bottom-color: var(--border-color);
        }

        [data-theme="dark"] .comment-author {
            color: var(--text-primary);
        }

        [data-theme="dark"] .comment-date {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .comment-content {
            color: var(--text-primary);
        }

        [data-theme="dark"] .comment-email {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .form-container {
            background: var(--card-bg);
        }

        [data-theme="dark"] .form-title {
            color: var(--text-primary);
        }

        [data-theme="dark"] .form-label {
            color: var(--text-primary) !important;
            font-weight: 500;
        }

        [data-theme="dark"] .page-header {
            color: var(--text-primary);
        }

        [data-theme="dark"] .no-comments {
            background: var(--card-bg);
            color: var(--text-secondary);
        }
{% endblock %}

{% block content %}
<div class="container">
        <div class="page-header">
            <h1>Komentarai</h1>
            <p class="lead">Palikite savo atsiliepimą apie duomenų analizės sistemą</p>
        </div>

        <!-- Komentaro pridėjimo forma -->
        <div class="form-container">
            <h3 class="form-title">Pridėti komentarą</h3>
            <form id="commentForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="vardas" class="form-label">Vardas *</label>
                        <input type="text" class="form-control" id="vardas" name="vardas" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="el_pastas" class="form-label">El. paštas</label>
                        <input type="email" class="form-control" id="el_pastas" name="el_pastas">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="komentaras" class="form-label">Komentaras *</label>
                    <textarea class="form-control" id="komentaras" name="komentaras" rows="4" required placeholder="Parašykite savo atsiliepimą apie sistemą..."></textarea>
                </div>
                <button type="submit" class="btn btn-submit">
                    <span class="submit-text">
                        Pateikti komentarą
                    </span>
                    <span class="loading-spinner">
                        <i class="fas fa-spinner fa-spin me-2"></i>Siunčiama...
                    </span>
                </button>
            </form>
        </div>

        <!-- Pranešimų zona -->
        <div id="alertContainer"></div>

        <!-- Komentarų sąrašas -->
        <div id="commentsContainer">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                <p class="mt-2">Kraunami komentarai...</p>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
// Komentarų valdymas
        class CommentsManager {
            constructor() {
                this.commentsContainer = document.getElementById('commentsContainer');
                this.alertContainer = document.getElementById('alertContainer');
                this.commentForm = document.getElementById('commentForm');

                this.bindEvents();
                this.loadComments();
            }

            bindEvents() {
                this.commentForm.addEventListener('submit', (e) => this.handleSubmit(e));
            }

            showAlert(message, type = 'success') {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                this.alertContainer.innerHTML = '';
                this.alertContainer.appendChild(alertDiv);

                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    if (alertDiv) {
                        alertDiv.remove();
                    }
                }, 5000);
            }

            setLoadingState(isLoading) {
                const submitBtn = this.commentForm.querySelector('button[type="submit"]');
                const submitText = submitBtn.querySelector('.submit-text');
                const loadingSpinner = submitBtn.querySelector('.loading-spinner');

                submitBtn.disabled = isLoading;
                submitText.style.display = isLoading ? 'none' : 'inline';
                loadingSpinner.style.display = isLoading ? 'inline' : 'none';
            }

            async handleSubmit(e) {
                e.preventDefault();

                const formData = new FormData(this.commentForm);
                const data = {
                    vardas: formData.get('vardas'),
                    el_pastas: formData.get('el_pastas'),
                    komentaras: formData.get('komentaras')
                };

                if (!data.vardas.trim() || !data.komentaras.trim()) {
                    this.showAlert('Prašome užpildyti visus privalomus laukus!', 'warning');
                    return;
                }

                this.setLoadingState(true);

                try {
                    const response = await fetch('/api/komentarai', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        this.showAlert('Komentaras sėkmingai pridėtas!', 'success');
                        this.commentForm.reset();
                        this.loadComments(); // Perkrauname komentarus
                    } else {
                        this.showAlert(result.error || 'Įvyko klaida pridedant komentarą', 'danger');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    this.showAlert('Įvyko klaida siunčiant komentarą', 'danger');
                } finally {
                    this.setLoadingState(false);
                }
            }

            async loadComments() {
                try {
                    const response = await fetch('/api/komentarai');
                    const data = await response.json();

                    if (response.ok) {
                        this.renderComments(data.komentarai);
                    } else {
                        this.showAlert(data.error || 'Nepavyko įkelti komentarų', 'danger');
                        this.renderEmptyState();
                    }
                } catch (error) {
                    console.error('Error loading comments:', error);
                    this.showAlert('Įvyko klaida kraunant komentarus', 'danger');
                    this.renderEmptyState();
                }
            }

            renderComments(comments) {
                if (!comments || comments.length === 0) {
                    this.renderEmptyState();
                    return;
                }

                const commentsHtml = comments.map(comment => this.renderComment(comment)).join('');

                this.commentsContainer.innerHTML = `
                    <h3 class="mb-4">Visi komentarai (${comments.length})</h3>
                    ${commentsHtml}
                `;
            }

            renderComment(comment) {
    const raw = comment.sukurimo_data;

    // Bandome sukurti Date objektą
    const date = new Date(raw);

    // Jei pavyko, formatuojam lietuviškai
    let shown = raw;
    if (!isNaN(date)) {
        shown = date.toLocaleString('lt-LT', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false,
            timeZone: 'UTC'   // !!! kad nerodytų poslinkio +3h
        });
    }

    return `
        <div class="comment-card">
            <div class="comment-header">
                <div>
                    <div class="comment-author">
                        ${this.escapeHtml(comment.vardas)}
                    </div>
                    ${comment.el_pastas ? `<div class="comment-email">
                        ${this.escapeHtml(comment.el_pastas)}
                    </div>` : ''}
                </div>
                <div class="comment-date">
                    ${shown}
                </div>
            </div>
            <div class="comment-content">
                ${this.escapeHtml(comment.komentaras).replace(/\n/g, '<br>')}
            </div>
        </div>
    `;
}



            renderEmptyState() {
                this.commentsContainer.innerHTML = `
                    <div class="no-comments">
                        <i class="fas fa-comment-slash fa-3x mb-3"></i>
                        <h4>Kol kas nėra komentarų</h4>
                        <p>Būkite pirmas, palikęs komentarą apie sistemą!</p>
                    </div>
                `;
            }

            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, function(m) { return map[m]; });
            }
        }

        // Inicializuojame komentarų valdyklę
        document.addEventListener('DOMContentLoaded', () => {
            new CommentsManager();
        });
</script>
{% endblock %}